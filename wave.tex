\section{Configuring ROMS for a Specific Application}
\label{Wave}
This chapter describes the parts of ROMS for which the user is
responsible when configuring it for a given application.  Section
\ref{User} describes the process in a generic fashion while
\S\ref{UpDown} and \S\ref{NEP} step through the application of ROMS
to upwelling/downwelling and wind-driven Northeast Pacific problems,
respectively.  As distributed, ROMS is ready to run quite a few
examples, where the C preprocessor flags determine which is to be
executed.  Some of these examples are described in Haidvogel and
Beckmann \cite{Haidvogel99}, some are listed here:
\begin{klist}
   \kitem{BASIN} This is a rectangular, flat-bottomed basin with
 double-gyre wind forcing. When run, it produces a western boundary
 current flowing into a central ``Gulf Stream''
 which goes unstable and generates eddies. The goal is to run
 adiabatically to study the homogenization of potential vorticity.
 It earned its nickname of Big Bad Basin by taking a long time to
 run and causing difficulties for the spectral versions of SPEM.
%   \kitem{CANYON\_A} The canyon is a periodic channel with a steep shelf
% along one wall, where the shelf contains a steep canyon.  There is a
% periodic forcing which causes the water to oscillate along the
% channel.  The rotation and the shelf lead to non-zero mean flows,
% especially near the canyon.  Version A is homogeneous and can be
% executed with a 2-D model.  See Haidvogel and Beckmann \cite{HB97} for
% a description of the canyon problems and the gravitational adjustment
% problem.
%   \kitem{CANYON\_B} This is like Canyon A, except that it is
% stratified.
%   \kitem{DAMEE\_4}  DAMEE stands for Data Assimilation and Model
% Evaluation Experiment and is a comparison of different models of
% the North Atlantic.  Version 4 is a big domain
% extending from 30$^\circ$ S to 65$^\circ$ N.  Additional input files
% are required to run the DAMEE configurations.
   \kitem{GRAV\_ADJ} The gravitational adjustment problem takes place
 in a long narrow domain which is initialized with dense water at one
 end and light water at the other. At time zero, the water is released
 and it generates two propagating fronts as the light water rushes to
 fill the top and the dense water rushes to fill the bottom. This
 configuration was used to test various advection schemes.
   \kitem{OVERFLOW}   This configuration is similar to the
 GRAV\_ADJ problem, but is initialized with dense water in the shallow
part of a domain with a sloping bottom.
   \kitem{SEAMOUNT}   The seamount test was used to test the pressure
 gradient errors.  It has an idealized seamount in a periodic channel.
 See Beckmann and Haidvogel \cite{BH93} and McCalpin \cite{McCalpin94}
 for more information.
   \kitem{UPWELLING}  The upwelling/downwelling example was
 contributed by Anthony Macks and Jason Middleton \cite{Macks93}
 and consists of a periodic channel with shelves on each side.
 There is along-channel wind forcing and the Coriolis term leads
 to upwelling on one side and downwelling on the other side. If
 you run it for several days without vertical mixing, you end up with
 dense water over light water.
\end{klist}
Some NetCDF input files for the ROMS examples can be found under
\code{Data/ROMS} in the ROMS distribution. The ASCII input files are
under \code{ROMS/External}.

\subsection{Configuring ROMS}
\label{User}

The four main sections you need to change in ROMS are the \code{makefile}
or \code{build.bash}, an include file with \code{cpp} options, any
analytic functions, and the ASCII input file. If more realistic fields
are desired, you will have to provide other input files as well, for
instance for the grid and the wind forcing.

\subsubsection{Case Name}

First, you need to decide on a name for your particular application or
configuration. This name is provided via the \code{ROMS\_APPLICATION} in
either the makefile or the build script. This name should be reasonably
short, all uppercase, with spaces converted to underscores. For example,
let's say we pick the name \code{WIKI\_TEST}. This name gets defined
during the build, so you can add code protected by \code{\#ifdef
WIKI\_TEST} as needed. This would be a good time to either copy the
makefile or the build Script to create one specific to this case prior
to editing it.

\subsubsection{ Case-specific Include File}

Each application has its own include file, included by
\code{cppdefs.h}. The name of this file is the name of your
application (\code{WIKI\_TEST} here) turned into lower case, with '.h'
appended (\code{wiki\_test.h}). The location of this file is set by
\code{MY\_HEADER\_DIR}, pointing to \code{User/Include} or some other
location of your choosing.

The complete list of options to be set prior to compilation are listed in
\S\ref{Cpp1}. Place those you need in the \code{wiki\_test.h} file. These
include algorithm choices (e.g. advection and turbulence closure schemes),
boundary conditions, output options (averages, diagnostics, stations,
floats), and application modules (biology, sediments). Each line should
be of the form:
\begin{verbatim}
        #define SOME_VAR
\end{verbatim}
Note that any undefined variable need not be mentioned.

Also note that if you copy a predefined application from
\code{ROMS/Include} as a template for your application, you must
rename it. If you don't change the name, ROMS will use the one in
\code{ROMS/Include} and your file will be ignored during the build
procedure.

\subsubsection{Functionals}

Some of the cpp Options have names beginning with \code{ANA\_}. For each one of
these, you will be expected to provide an analytic expression for the field
in question in the corresponding include file. These files
are listed in \S\ref{Functionals} and their location is determined
by \code{MY\_ANALYTICAL\_DIR}. You may chose to copy those from
\code{User/Functionals} to some new directory and place your version of
the assignments within
\begin{verbatim}
        #ifdef WIKI_TEST
        ! Set weird and wonderful winds
           :
        #endif
\end{verbatim}
This makes
it easy to search for later, if nothing else.

\subsubsection{\code{checkdefs.F}}

For each new \code{cpp} variable other than your application name,
it is recommended that you also
add the appropriate code to \code{checkdefs.F}, such as:
\begin{verbatim}
       #ifdef SLEET
             IF (Master) WRITE(stdout,20) 'SLEET',                      &
            &   'Sleet falling on the ice option.'
             is=lenstr(Coptions)+1
             Coptions(is:is+7)=' SLEET,'
       #endif /* ICE */
\end{verbatim}
Note that the number ``7'' on the \code{Coptions} line must be set
according to the length of the string you are adding.  In this case 7
is for `` SLEET,'', including the comma and the space. Again, you do not
need to do this for your application name (\code{WIKI\_TEST} here),
since \code{checkdefs} will print whatever is in \code{MyAppCPP}.

\subsubsection{Model domain}
\label{Muddy}
One of the first things the user must decide is how many grid points
to use, and can be afforded.  There are three parameters in
\code{ocean.in} which specify the grid size and one parameter for the
number of active tracers:
\begin{tabbing}
  Gnu \= Allolo \= \kill
  \> \code{Lm} \> Number of finite-difference points in $\xi$. \\
  \> \code{Mm} \> Number of finite-difference points in $\eta$. \\
  \> \code{N} \> Number of finite-difference points in the vertical. \\
  \> \code{NAT} \> Number of active tracers. \\
\end{tabbing}
The number of biological tracers is set in the \code{biology.in} file.
There are no constraints on these except $\code{Lm} \geq 2$, $\code{Mm}
\geq 2$, $\code{N} \geq 2$ and $\code{NAT} \geq 1$.  \code{Lm} and
\code{Mm} should be at least 3 if the domain is periodic in that
direction.

\subsubsection{$x,y$ grid}
The subroutine \code{get\_grid} or \code{ana\_grid} is called by
\code{initial} to set the grid arrays, the bathymetry, and the
Coriolis parameter.  Most of the simple test problems have their grid
information specified in \code{ana\_grid.h} in the directory
\code{ROMS/Functionals}.  More realistic problems require a NetCDF grid
file, produced by the grid generation programs described in Wilkin and
Hedstrom \cite{GRIDS}, by the Matlab \code{SeaGrid}, or by some
other method.  The variables which are read by \code{get\_grid} are:
\begin{tabbing}
  Gnu \= \kill
  \> \code{xl, el, spherical, f, h, pm, pn, x\_rho, y\_rho,
  lon\_rho, lat\_rho, angle}.
\end{tabbing}
If the grid is curved, \code{get\_grid} will also read:
\begin{tabbing}
  Gnu \= \kill
  \> \code{dndx, dmde}.
\end{tabbing}
Likewise, if \code{MASKING} is defined, it will read:
\begin{tabbing}
  Gnu \= \kill
  \> \code{mask\_rho, mask\_u, mask\_v, mask\_psi}.
\end{tabbing}

\subsubsection {$\xi,\eta$ grid}
Before providing initial conditions and boundary conditions, the
user must understand the model grid. The fields are laid out on an
Arakawa C grid as in Fig.\ \ref{fcgr}. The overall grid is shown in
Fig.\ \ref{fwgr}.  The thick outer line shows the position of the
model boundary. The points inside this boundary are those which are
advanced in time using the model physics. The points on the boundary
and those on the outside must be supplied by the boundary
conditions.

The three-dimensional model fields are carried in four-dimensional
arrays, where the fourth array index refers to one of two or three
time levels. The tracers have a fifth array index telling which
tracer is being referred to.
For instance, $\code{itemp}=1$ refers to
potential temperature while $\code{isalt}=2$ refers to salinity.  The
integers $i$, $j$, and $k$ are used throughout the model to index
the three spatial dimensions:
\begin{tabbing}
Gnus \= Gnus \= \kill
   \>$i$ \>Index variable for the $\xi$-direction. \\
   \>$j$ \>Index variable for the $\eta$-direction. \\
   \>$k$ \>Index variable for the $\sigma$-direction.  $k = 1$
   refers to the bottom \\
biggnu \= \kill
   \>while $k = \code{N}$ refers to the surface.
\end{tabbing}

%The range of $\xi$ is 1 to \code{L} and the range of $\eta$ is 1 to
%\code{M}.  Therefore $i$ and $\xi$ are the same at $\psi$
%points, as are $j$ and $\eta$.  (This matters in the floats---Dale and
%I disagreed on how this should be and then Dale later changed to my
%point of view after I had recoded things to match his).

\subsubsection{Initial conditions}
The initial values for the model fields are provided by either
\code{ana\_initial} or \code{get\_state}.  \code{get\_state} is
also used to read a restart file if the model is being restarted from a
previous run.

Also in \code{initial}, \code{rho\_eos} is called to initialize
the density field. \code{rho\_eos} also computes \code{rhoA},
the vertically averaged density, and \code{rhoS}, the density
perturbation. Both \code{rhoA} and \code{rhoS} are used in the barotropic
pressure gradient.

%The tracer climatology fields also require appropriate values if they
%are to be used, and are provided by \code{ana\_tclima} or
%\code{get\_tclima}. Likewise, the surface height climatology is read by
%\code{get\_ssh} or provided by \code{ana\_ssh}.

\subsubsection{Equation of state}
The equation of state is defined in the subroutine \code{rho\_eos}.  Two
versions are provided in ROMS: a nonlinear $\rho =
\rho(T,S,z)$ from Jackett and McDougall \cite{Jackett} and a linear
$\rho(T,S)$.  The linear form is
$$
      \rho = \code{R0} - \code{Tcoef} \cdot (T-T0) +
      \code{Scoef} \cdot (S-S0)
$$
or
$$
     \rho = \code{R0} + \code{Tcoef} \cdot (T-T0),
$$
depending on whether or not
\code{SALINITY} is defined.  Specify which equation of state you
would like to use with the \code{NONLIN\_EOS} C preprocessor flag in your
application include file. The linear coefficients \code{R0}, \code{T0},
\code{Tcoef}, \code{S0}, and \code{Scoef} are set in \code{ocean.in}. Note
that we are computing {\em in situ} density from potential temperature and
salinity. Some of the vertical mixing schemes require potential density
and some other fields, which are computed by \code{rho\_eos} as well.

\subsubsection{Boundary conditions}
\label{Bcs}
The horizontal boundary conditions are provided by the subroutines
in \code{u3dbc\_im}, \code{v3dbc\_im}, \code{u2dbc\_im}, \code{v2dbc\_im},
\code{t3dbc\_im}, and \code{zetabc}.  They are called every time-step
and provide the boundary values for the fields $u, v, \overline{u},
\overline{v}$, all tracers, and $\zeta$, respectively. They are currently
configured for a closed basin, a periodic channel, a doubly periodic
domain or a domain with various open boundary conditions. Each side is
controlled independently with \code{WEST} being the \code{i=1} boundary,
\code{EAST} being the \code{i=L} boundary, \code{SOUTH} being the \code{j=1}
boundary, and \code{NORTH} being the \code{j=M} boundary. These choices are
made via the \code{cpp} options in your include file.

Many of the choices for open boundaries require that the model have
some boundary values for the field in question. These can be specified in
the appropriate \code{ana\_xxx.h} file for say \code{ANA\_TOBC} or
they can be read from a boundary NetCDF file. There is logic in
\code{globaldefs.h} by which ROMS decides whether or not it needs to
read a boundary file.

\subsubsection{Model forcing}
\label{Mforce}
\noindent {\bf(a) Winds and thermal fluxes}

There are two different ways to apply a wind forcing: as a surface
momentum flux in the vertical viscosity term, or as a body force over
the upper water column.
Usually, we set the vertical $\sigma$-coordinate
parameters to retain some resolution near the surface and apply the
fluxes as boundary conditions to the vertical viscosity/diffusivity.
In either case, the surface and bottom fluxes are either defined
analytically, read from a forcing file, or computed inside ROMS
using a bulk flux formula from the appropriate atmospheric fields
(air temperature and winds, for instance).  You must either edit the
appropriate \code{ana\_xxx.h} or create a NetCDF forcing
file in the format expected by ROMS. Note that it is quite common
to put the surface variables in the forcing file while having an analytic
bottom heat flux. ROMS now has the capability of reading in a list
of forcing fields---it can be convenient to have one file per field
rather than stuffing tides, winds, river inputs all into one file.

In the past, our vertical resolution was relatively coarse and the
vertical viscosity would have to have been unreasonably large for
us to resolve the surface Ekman layer.  If that is your situation,
define \code{BODYFORCE} in \code{cppdefs.h} and provide a value for
\code{levsfrc} in \code{ocean.in}.  The forcing is applied over the
levels from \code{levsfrc} to \code{N}.  The above caution about
vertical resolution also applies to the surface fluxes of $T$ and
$S$, although \code{BODYFORCE} only refers to wind stress, not the
surface tracer fluxes.

\smallskip
\noindent {\bf(b) Climatology}

One way to force the model is via a nudging to the tracer and/or
momentum climatologies. Nudging to tracers was used in the North
Atlantic simulations in sponge layers along the northern and southern
boundaries. Set the climatologies in \code{ana\_tclima.h} or in a
file read by \code{get\_data}, set \code{TCLM\_NUDGING} in
\code{wiki\_test.h} and also set the array \code{Tnudgcof} in
\code{ana\_nudgcoef.h}.

\smallskip
\noindent {\bf(c) Tides}

There is also more than one way to force with tides. One way is to
provide boundary conditions with enough temporal resolution to
resolve the tides. Another is to provide ROMS with the tidal
constituents at all grid points and to have ROMS reconstruct the
tidal currents (\code{UV\_TIDES})  and/or elevations (\code{SSH\_TIDES})
for any given time. An example of such a tidal forcing file is in
\code{Data/ROMS/Forcing/test\_head\_frc.nc}.

The non-trunk code with ice, etc. includes an option to
add on the long-period tides (\code{TIDES\_ASTRO}) from Foreman
(\cite{Foreman_96a} and \cite{Foreman_96b}). There is also an option to include the tidal potential
forcing term (\code{POT\_TIDES}), requiring the tidal potential to
be included in the tides forcing file.

\smallskip
\noindent {\bf(d) Rivers}

Point sources can be used to provide river inflow to the model.
These too can be specified in a forcing file if not provided via
\code{ana\_psource}.

\subsubsection{\code{ocean.in}}
\label{ASCII_in}
ROMS expects to read a number of variables from an ASCII file as described
in \S\ref{Running}.
Example input files are in \code{ROMS/External} with names like
\code{ocean\_grav\_adj.in}, where ``grav\_adj'' refers to the name of
the application. Lines beginning with ``!'' are comments and will be
ignored by ROMS on reading them.

The input is organized as key/value pairs, separated by one or two
equals signs. It is possible for ROMS to run on more than one grid
simultaneously, with the number of grids being set at compile time
via the build script and/or the \code{makefile}. If there is one
equals sign (\code{=}), ROMS will use the corresponding value for
all grids. If there are two (\code{==}), ROMS will read a value for
each grid. Thus far, our domains have used just one grid since the
inter-grid coupling has not been released.

ROMS will ignore the parameters not needed by the current
simulation, e.g., the GLS parameters will not be read if you are not
using that mixing scheme. However, I believe all the example files
contain all possible parameters (except the ice branch ones).
The input parameters are in groups, as follows:
\begin{klist}
   \kitem{Header} \mbox{}
     \begin{klist}
   \kitem{TITLE} A text string to put in the output files.
   \kitem{MyAppCPP} The shorthand name for this application.
   \kitem{VARNAME} The location of the \code{varinfo.dat} file
     containing information about fields to read/write from/to NetCDF
     files.
     \end{klist}
   \kitem{Grid-dimension parameters} \mbox{}
     \begin{klist}
       \kitem{Lm} Number of $i$-direction INTERIOR RHO-points.
       \kitem{Mm} Number of $j$-direction INTERIOR RHO-points.
       \kitem{N} Number of vertical levels.
       \kitem{Nbed} Number of sediment bed layers.
       \kitem{NAT} Number of active tracers (usually 2).
       \kitem{NPT} Number of passive tracers.
       \kitem{NCS} Number of cohesive (mud) sediment tracers.
       \kitem{NNS} Number of non-cohesive (sand) sediment tracers.
     \end{klist}
   \kitem{Domain-decomposition parameters} \mbox{}
     \begin{klist}
       \kitem{NtileI} Number of $i$-direction partitions.
       \kitem{NtileJ} Number of $j$-direction partitions.
     \end{klist}
   \kitem{Time-stepping parameters} \mbox{}
     \begin{klist}
       \kitem{NTIMES}    Number of time-steps to evolve the 3-D
       equations in the current run.  This is actually the total
     number, including any previous segments of the same run.  For
     instance, if you already did a three-month run and wish to
     continue for another three months, set \code{NTIMES} to the
     number of steps needed for six months.
       \kitem{DT}        Time-step in seconds for the 3-D equations.
       \kitem{NDTFAST}   Number of time-steps for the 2-D equations
     to be executed each \code{dt}.
     \end{klist}
   \kitem{Model iteration loops parameters} \mbox{}
     \begin{klist}
       \kitem{ERstr} Starting ensemble run number.
       \kitem{ERend} Ending ensemble run number.
       \kitem{Nouter} Maximum number of 4DVAR outer loop iterations.
       \kitem{Ninner} Maximum number of 4DVAR inner loop iterations.
       \kitem{Nintervals} Number of time interval divisions for
       stochastic optimals computations.
     \end{klist}
   \kitem{Generalized Stability Theory (GST) parameters} \mbox{}
     \begin{klist}
       \kitem{NEV} Number of eigenvalues.
       \kitem{NCV} Number of eigenvectors.
     \end{klist}
   \kitem{Input/Output parameters} \mbox{}

   ROMS has several possible output files. The output files can
   include a restart file, a history file, an averages file, and a
   station file, for instance.  The restart file often contains
   only two records with the older record being overwritten during
   the next write.  The history file can contain a subset of the
   restart fields, for instance just the surface elevation and the
   surface temperature.  The averages file contains time-averages
   of the model fields, for instance daily or monthly means,
   depending on \code{NAVG}.  The station file contains timeseries
   for specified points, possibly quite frequently since each record
   is small. For some, machinery is in place to write multiple
   files, numbering them \_0001, \_0002, etc.
     \begin{klist}
       \kitem{NRREC}     Record number of the restart file to read
     as the initial conditions. Set to 0 at the beginning of the
     run, -1 to read the latest record.
       \kitem{LcycleRST} Logical, true to cycle between two records
     of the restart file.
       \kitem{NRST}      Number of time-steps between writing of
     restart fields.
       \kitem{NSTA}      Number of time-steps between writing fields
     into the stations file.
       \kitem{NFLT}      Number of time-steps between writing fields
     into the floats file.
       \kitem{NINFO}     Number of time-steps between calling
       \code{diag} to write some global information and check for
       NaN values. 
     \end{klist}
   \kitem{History, average, diagnostic output parameters} \mbox{}
     \begin{klist}
       \kitem{LDEFOUT} True for creating new output files for
       stations, history, floats, etc. If false, output is appended
       to these files.
       \kitem{NHIS}  Number of time-steps between writing history
       records.
       \kitem{NDEFHIS}  Number of time-steps between starting new history
       files.
       \kitem{NTSAVG}    Starting time-step for the accumulation of
     output time-averaged data.  For instance, you might want to average
     over the last day of a thirty-day run.
       \kitem{NAVG}      Number of time-steps between writing
     time-averaged data into the averages file.
       \kitem{NDEFAVG}      Number of time-steps between starting
     new averages files.
       \kitem{NTSDIA}    Starting time-step for the accumulation of
     output diagnostics data.  For instance, you might want to write
     diagnostics for the last day of a thirty-day run.
       \kitem{NDIA}      Number of time-steps between writing
     diagnostics data into the diagnostics file.
       \kitem{NDEFDIA}      Number of time-steps between starting
     new diagnostics files.
     \end{klist}
    \kitem{Tangent linear and adjoint output parameters} \mbox{}
     \begin{klist}
       \kitem{LcycleTLM} Logical, true to cycle between two records
       \kitem{NTLM}      Number of time-steps between writing
     tangent linear data.
       \kitem{NDEFTLM}      Number of time-steps between starting
     new tangent linear files.
       \kitem{LcycleADJ} Logical, true to cycle between two records
     of the restart file.
       \kitem{NADJ}      Number of time-steps between writing
     adjoint data.
       \kitem{NDEFADJ}      Number of time-steps between starting
     new adjoint files.
       \kitem{NSFF}     Number of time-steps between 4DVAR adjustment of
       surface forcing fluxes.
       \kitem{NOBC}    Number of time-steps between 4DVAR adjustment of
       open boundary fields.
     \end{klist}
    \kitem{Check-pointing GST restart parameters} \mbox{}
     \begin{klist}
       \kitem{LrstGST} GST restart switch.
       \kitem{MaxIterGST} Maximum number of iterations.
       \kitem{NGST} Check-pointing interval.
     \end{klist}
    \kitem{Ritz GST parameter} \mbox{}
     \begin{klist}
       \kitem{Ritz\_tol} Relative accuracy of the Ritz values
       computed in the GST analysis.
     \end{klist}
   \kitem{Horizontal mixing of tracers} \mbox{}
     \begin{klist}
       \kitem{TNU2}     Constant mixing
     coefficient for the horizontal Laplacian diffusion of each tracer.
     A value is expected for each of the \code{NAT+NPT} tracers.
       \kitem{TNU4}     Constant mixing
     coefficient for the horizontal biharmonic diffusion of each tracer.
     A value is expected for each of the \code{NAT+NPT} tracers.
     \end{klist}
   \kitem{Horizontal viscosity coefficients} \mbox{}
     \begin{klist}
       \kitem{VISC2}    Constant mixing coefficient for the horizontal
     Laplacian viscosity.
       \kitem{VISC4}    Constant mixing coefficient for the horizontal
     biharmonic viscosity.
     \end{klist}
   \kitem{Vertical mixing coefficients for tracers} \mbox{}
     \begin{klist}
       \kitem{AKT\_BAK}  Background vertical mixing coefficient
     for the tracers (\code{NAT+NPT} values).
     \end{klist}
   \kitem{Vertical mixing coefficient for momentum} \mbox{}
     \begin{klist}
       \kitem{AKV\_BAK}  Background vertical mixing coefficient 
     for momentum.
     \end{klist}
   \kitem{Turbulent closure parameters} \mbox{}
     \begin{klist}
       \kitem{AKK\_BAK}  Background vertical mixing coefficient
     for turbulent kinetic energy.
       \kitem{AKP\_BAK}  Background vertical mixing coefficient
     for turbulent kinetic energy.
       \kitem{TKENU2}    Constant mixing coefficient for the horizontal
     Laplacian diffusion of turbulent kinetic energy.
       \kitem{TKENU4}    Constant mixing coefficient for the horizontal
     biharmonic diffusion of turbulent kinetic energy.
     \end{klist}
   \kitem{Generic length-scale turbulence closure parameters}
   \mbox{}
     \begin{klist}
       \kitem{GLS\_P}   Stability exponent.
       \kitem{GLS\_M}   Turbulent kinetic energy exponent.
       \kitem{GLS\_N}   Turbulent length scale exponent.
       \kitem{GLS\_Kmin}  Minimum value of specific turbulent kinetic
       energy.
       \kitem{GLS\_Pmin}  Minimum value of dissipation.
       \kitem{GLS\_CMU0}   Stability coefficient.
       \kitem{GLS\_C1}   Shear production coefficient.
       \kitem{GLS\_C2}   Dissipation coefficient.
       \kitem{GLS\_C3M}   Buoyancy production coefficient (minus).
       \kitem{GLS\_C3P}   Buoyancy production coefficient (plus).
       \kitem{GLS\_SIGK} Constant Schmidt number (non-dimensional) for
       turbulent kinetic energy diffusivity.
       \kitem{GLS\_SIGP}  Constant Schmidt number (non-dimensional) for
       turbulent generic statistical field, ``psi''.
     \end{klist}
   \kitem{Constants used in surface TKE flux computation} \mbox{}
     \begin{klist}
       \kitem{CHARNOK\_ALPHA} Charnok surface roughness.
       \kitem{ZOS\_HSIG\_ALPHA} Roughness from wave amplitude.
       \kitem{SZ\_ALPHA} Roughness from wave dissipation.
       \kitem{CRGBAN\_CW} Craig and Banner wave breaking.
     \end{klist}
   \kitem{Bottom drag coefficients} \mbox{}
     \begin{klist}
       \kitem{RDRG}     Linear bottom drag coefficient.
       \kitem{RDRG2}    Quadratic bottom drag coefficient.
       \kitem{Zob}       Bottom roughness.
       \kitem{Zos}       Surface roughness (under ice shelves).
     \end{klist}
   \kitem{Height of atmospheric measurements for bulk flux
   parameterizations} \mbox{}
     \begin{klist}
       \kitem{BLK\_ZQ} Height of air humidity values.
       \kitem{BLK\_ZT} Height of air temperature values.
       \kitem{BLK\_ZW} Height of wind values.
     \end{klist}
   \kitem{Wetting and drying parameter} \mbox{}
     \begin{klist}
       \kitem{DCRIT}  Minimum depth for dry cells.
     \end{klist}
   \kitem{Various parameters} \mbox{}
     \begin{klist}
       \kitem{WTYPE}  Jerlov water type.
       \kitem{LEVSFRC}  Deepest level to apply surface momentum
     stresses as a body force.
            Used when the C-preprocessor option BODYFORCE is defined.
       \kitem{LEVBFRC}  Shallowest level to apply bottom momentum
    stresses as a body force.
            Used when the C-preprocessor option BODYFORCE is defined.
     \end{klist}
   \kitem{Vertical coordinate parameters} \mbox{}
     \begin{klist}
       \kitem{Vtransform} Transformation equation, 1 for old style.
       \kitem{Vstretching} Stretching function, 1 for old style.
     \end{klist}
   \kitem{Vertical $\sigma$-coordinates parameters} \mbox{}
     \begin{klist}
       \kitem{theta\_s}  $\sigma$-coordinate surface control parameter,
     [$0 < \code{theta\_s} < 20$].
       \kitem{theta\_b}  $\sigma$-coordinate bottom  control parameter,
     [$0 < \code{theta\_b} < 1$].
       \kitem{Tcline}   Width of the surface or bottom boundary layer
     in which higher vertical resolution is required during stretching.
     \end{klist}
   \kitem{Mean Density and Brunt-V\"ais\"al\"a frequency} \mbox{}
     \begin{klist}
       \kitem{RHO0}     Mean density used in the Boussinesq
     approximation.
       \kitem{BVF\_BAK} Background Brunt-V\"ais\"al\"a frequency squared.
     \end{klist}
   \kitem{Time parameters} \mbox{}
     \begin{klist}
       \kitem{DSTART}   Time stamp assigned to model initialization
     (days).
       \kitem{TIDE\_START}   Time of tidal origin relative to model
       origin.
       \kitem{TIME\_REF}  Reference time in the format yyyymmdd.dd or
       else a special value for specific calendars as documented in the
       \code{ocean.in} files.
     \end{klist}
  \kitem{Nudging time scales} \mbox{}
     \begin{klist}
       \kitem{TNUDG}    Time scale (days) of nudging towards
     tracer climatology at the interior and at the boundaries.
     A value is expected for each active tracer.
       \kitem{ZNUDG}    Time scale (days) of nudging towards
     free surface climatology at the interior and at the boundaries.
       \kitem{M2NUDG}    Time scale (days) of nudging towards
     2-D momentum climatology at the interior and at the boundaries.
       \kitem{M3NUDG}    Time scale (days) of nudging towards
     3-D momentum climatology at the interior and at the boundaries.
     \end{klist}
   \kitem{Open boundary factor} \mbox{}
     \begin{klist}
       \kitem{OBCFAC}   Ratio of inflow and outflow nudging time scales.
     \end{klist}
   \kitem{Linear equation of state parameters} \mbox{}
     \begin{klist}
       \kitem{R0}       Background density value used in
    the linear equation of state.
       \kitem{T0}       Background potential temperature constant.
       \kitem{S0}       Background salinity constant.
       \kitem{TCOEF}    Thermal expansion coefficient in the linear
    equation of state.
       \kitem{SCOEF}    Saline contraction coefficient in the linear
    equation of state.
     \end{klist}
   \kitem{Slipperiness parameter} \mbox{}
     \begin{klist}
       \kitem{gamma2}   Slipperiness variable, either 1.0 (free
     slip) or $-1.0$ (no slip).
     \end{klist}
   \kitem{Adjoint sensitivity time parameters} \mbox{}
     \begin{klist}
       \kitem{DstrS} Starting day.
       \kitem{DendS} Ending day.
     \end{klist}
   \kitem{Adjoint sensitivity vertical level parameters} \mbox{}
     \begin{klist}
       \kitem{KstrS} Starting level.
       \kitem{KendS} Ending level.
     \end{klist}
   \kitem{Adjoint sensitivity logical parameters} \mbox{}
     \begin{klist}
       \kitem{Lstate(isFsur)} Free surface.
       \kitem{Lstate(isUbar)} 2D $u$-momentum.
       \kitem{Lstate(isVbar)} 2D $v$-momentum.
       \kitem{Lstate(isUvel)} 3D $u$-momentum.
       \kitem{Lstate(isVvel)} 3D $v$-momentum.
       \kitem{Lstate(isTvar)} Tracers (NT values expected).
     \end{klist}
   \kitem{Stochastic optimals time scale} \mbox{}
     \begin{klist}
       \kitem{SO\_decay}  Stochastic optimals time decorrelation
       scale (days) assumed for red noise processes.
     \end{klist}
   \kitem{Logicals for stochastic optimals} \mbox{}
     \begin{klist}
       \kitem{SOstate(isUstr)}  Surface $u$-stress.
       \kitem{SOstate(isVstr)}  Surface $v$-stress.
       \kitem{Lstate(isTsur)} Surface tracer flux (NT values expected).
     \end{klist}
   \kitem{Stochastic optimals surface standard deviations} \mbox{}
     \begin{klist}
       \kitem{SO\_sdev(isUstr)} Surface $u$-stress.
       \kitem{SO\_sdev(isVstr)} Surface $v$-stress.
       \kitem{SO\_sdev(isTsur)} Surface tracer flux (NT values
       expected).
     \end{klist}
   \kitem{Logical switches to activate the writing of
   history/averages fields} \mbox{}
     \begin{klist}
       \kitem{Hout(idUvel)}    3-D $u$-velocity component.
       \kitem{Hout(idVvel)}    3-D $v$-velocity component.
       \kitem{Hout(idWvel)}    3-D $w$-velocity component.
       \kitem{Hout(idOvel)}    3-D $\Omega$ vertical velocity.
       \kitem{Hout(idUbar)}  2-D $u$-velocity component.
       \kitem{Hout(idVbar)}  2-D $v$-velocity component.
       \kitem{Hout(idFsur)}     Free-surface.
       \kitem{Hout(idBath)}     Time-dependent bathymetry.
\vspace{2 mm}
       \kitem{Hout(idTvar)}     Tracer type variables: potential
    temperature, salinity, etc.
\vspace{2 mm}
       \kitem{Hout(idUsms)}   Surface $u$-stress.
       \kitem{Hout(idVsms)}   Surface $v$-stress.
       \kitem{Hout(idUbms)}   Bottom $u$-stress.
       \kitem{Hout(idVbms)}   Bottom $v$-stress.
\vspace{2 mm}
       \kitem{Hout(idUbrs)}   Bottom $u$-current stress.
       \kitem{Hout(idVbrs)}   Bottom $v$-current stress.
       \kitem{Hout(idUbws)}   Bottom $u$-wave stress.
       \kitem{Hout(idVbws)}   Bottom $v$-wave stress.
       \kitem{Hout(idUbcs)}   Bottom max wave-current $u$-stress.
       \kitem{Hout(idVbcs)}   Bottom max wave-current $v$-stress.
\vspace{2 mm}
       \kitem{Hout(idUbot)}   Bed wave orbital $u$-velocity.
       \kitem{Hout(idVbot)}   Bed wave orbital $v$-velocity.
       \kitem{Hout(idUbur)}   Bottom max wave-current $u$-stress.
       \kitem{Hout(idVbur)}   Bottom max wave-current $v$-stress.
\vspace{2 mm}
       \kitem{Hout(idW2xx)}  2D radiation stress, $S_{xx}$ component.
       \kitem{Hout(idW2xy)}  2D radiation stress, $S_{xy}$ component.
       \kitem{Hout(idW2yy)}  2D radiation stress, $S_{yy}$ component.
       \kitem{Hout(idU2rs)}  2D $u$-radiation stress.
       \kitem{Hout(idV2rs)}  2D $v$-radiation stress.
       \kitem{Hout(idU2Sd)}  2D $u$-Stokes velocity.
       \kitem{Hout(idV2Sd)}  2D $v$-Stokes velocity.
\vspace{2 mm}
       \kitem{Hout(idW3xx)}  3D radiation stress, $S_{xx}$ component.
       \kitem{Hout(idW3xy)}  3D radiation stress, $S_{xy}$ component.
       \kitem{Hout(idW3yy)}  3D radiation stress, $S_{yy}$ component.
       \kitem{Hout(idW3zx)}  3D radiation stress, $S_{zx}$ component.
       \kitem{Hout(idW3zy)}  3D radiation stress, $S_{zy}$ component.
       \kitem{Hout(idU3rs)}  3D $u$-radiation stress.
       \kitem{Hout(idV3rs)}  3D $v$-radiation stress.
       \kitem{Hout(idU3Sd)}  3D $u$-Stokes velocity.
       \kitem{Hout(idV3Sd)}  3D $v$-Stokes velocity.
\vspace{2 mm}
       \kitem{Hout(idWamp)}  Wave height.
       \kitem{Hout(idWlen)}  Wave length.
       \kitem{Hout(idWdir)}  Wave direction.
\vspace{2 mm}
       \kitem{Hout(idTsur)}  Surface net heat and salt flux (NAT values).
       \kitem{Hout(idLhea)}  Latent heat flux.
       \kitem{Hout(idShea)}  Sensible heat flux.
       \kitem{Hout(idLrad)}  Longwave radiation flux.
       \kitem{Hout(idSrad)}  Shortwave radiation flux.
       \kitem{Hout(idEmPf)}  E-P flux.
       \kitem{Hout(idevap)}  Evaporation rate.
       \kitem{Hout(idrain)}  Precipitation rate.
\vspace{2 mm}
       \kitem{Hout(idDano)}   Density anomaly.
       \kitem{Hout(idVvis)}   Vertical viscosity coefficient.
       \kitem{Hout(idTdif)}   Vertical diffusion coefficient for
     temperature.
       \kitem{Hout(idSdif)}   Vertical diffusion coefficient for
     salinity.
       \kitem{Hout(idHsbl)}   Depth of the surface boundary layer.
       \kitem{Hout(idHbbl)}   Depth of the bottom boundary layer.
       \kitem{Hout(idMtke)}   Turbulent kinetic energy.
       \kitem{Hout(idMtls)}   Turbulent length scale.
     \end{klist}
   \kitem{Ice fields} \mbox{}
     \begin{klist}
       \kitem{Hout(idUice)}    Ice $u$-velocity.
       \kitem{Hout(idVice)}    Ice $v$-velocity.
       \kitem{Hout(idAice)}    Ice concentration.
       \kitem{Hout(idHice)}    Ice thickness.
       \kitem{Hout(idTice)}    Ice surface temperature.
       \kitem{Hout(idHsno)}    Snow thickness.
       \kitem{Hout(idTimid)}    Ice internal temperature.
       \kitem{Hout(idSfwat)}    Surface water (melt ponds).
       \kitem{Hout(idTauiw)}    Tauiw.
       \kitem{Hout(idChuiw)}    Chuiw.
       \kitem{Hout(idAgeice)}    Ice age.
       \kitem{Hout(idSig11)}    Ice internal stress, 11 component.
       \kitem{Hout(idSig12)}    Ice internal stress, 12 component.
       \kitem{Hout(idSig22)}    Ice internal stress, 22 component.
       \kitem{Hout(idS0mk)}    Under-ice salinity.
       \kitem{Hout(idT0mk)}    under-ice temperature.
       \kitem{Hout(idWfr)}    Frazil ice growth rate.
       \kitem{Hout(idWai)}    Air-ice melt rate.
       \kitem{Hout(idWao)}    Air-ocean ice growth rate.
       \kitem{Hout(idWio)}    Ice-ocean ice melt/growth rate.
       \kitem{Hout(idWro)}    Surface water runoff rate.
     \end{klist}
   \kitem{Inert (passive) tracers} \mbox{}
     \begin{klist}
       \kitem{Hout(inert)}    Passive tracers (NPT values).
     \end{klist}
   \kitem{Sediment tracers} \mbox{}
     \begin{klist}
       \kitem{Hout(idBott)}    Sediment tracers (MBOTP values).
     \end{klist}
   \kitem{User parameters} \mbox{}
     \begin{klist}
       \kitem{NUSER}    Number of user parameters
       \kitem{USER}     Values of user parameters (NUSER values).
     \end{klist}
   \kitem{NetCDF-4/HDF5 parameters} \mbox{}
     \begin{klist}
       \kitem{NC\_SHUFFLE}    If non-zero, turn on shuffle filter.
       \kitem{NC\_DEFLATE}    If non-zero, turn on deflate filter.
       \kitem{NC\_DLEVEL}    Deflate level (0--9).
     \end{klist}
   \kitem{Input NetCDF file names} \mbox{}
     \begin{klist}
       \kitem{GRDNAME}  Grid file.
       \kitem{ININAME}  Initial conditions file.
       \kitem{ITLNAME}  Initial tangent linear file.
       \kitem{IRPNAME}  Initial representer file.
       \kitem{IADNAME}  Initial adjoint file.
       \kitem{CLMNAME}  Climatology file.
       \kitem{BRYNAME}  Boundary condition file.
       \kitem{FWDNAME}  Forward model file.
       \kitem{ADSNAME}  Adjoint sensitivity functional file.
     \end{klist}
    \kitem{Forcing NetCDF files} \mbox{}
     \begin{klist}
       \kitem{NFFILES}  Number of forcing files.
       \kitem{FRCNAME}  Forcing files.
     \end{klist}
    \kitem{Output NetCDF file names} \mbox{}
     \begin{klist}
       \kitem{GSTNAME}  GST analysis restart file.
       \kitem{RSTNAME}  Restart file.
       \kitem{HISNAME}  History file.
       \kitem{TLMNAME}  Tangent linear file.
       \kitem{TLFNAME}  Impulse forcing file (for tangent linear model).
       \kitem{ADJNAME}  Adjoint file.
       \kitem{AVGNAME}  Averages file.
       \kitem{STANAME}  Stations file.
       \kitem{FLTNAME}  Lagrangian floats file.
     \end{klist}
   \kitem{ASCII input file names} \mbox{}
     \begin{klist}
       \kitem{APARNAM}  Assimilation parameters.
       \kitem{SPOSNAM}  Stations positions.
       \kitem{FPOSNAM}  Initial drifter positions.
       \kitem{IPARNAM}  Ice parameters.
       \kitem{BPARNAM}  Biology parameters.
       \kitem{SPARNAM}  Sediment parameters.
       \kitem{USRNAME}  User's generic input.
     \end{klist}
\end{klist}
The bottom of the sample files contain comments describing some of these in
greater detail.

%An example input file without the trailing comments is:
%\begin{verbatim}
%\end{verbatim}

\subsubsection{User variables and subroutines}
\label{Store}
It is possible for the user to add new variables and functionality,
though it is discouraged. The design goal is to isolate the most common
features a user would change to the \code{cpp} switches
(\S\ref{Cpp1}), the \code{ana\_xx.h} files (\S\ref{Functionals}) and
the ASCII input file (\S\ref{ASCII_in}). A query on the ROMS forum
might be in order if you have something specific in mind.

If you do choose to add bits, know that the \code{makefile}
fragments called \code{Module.mk} will attempt to compile anything
with a \code{.F} extension in the directories already populated with
such code.

\subsection{Upwelling/Downwelling Example}
\label{UpDown}
The application which ROMS is configured to run as distributed
is a wind-driven
upwelling and downwelling example, described in Macks and Middleton
\cite{Macks93}.  There is a shelf on each wall of a periodic channel
and an along-channel wind forcing, which drives upwelling at one wall
and downwelling at the other.  This problem depends on the Ekman layer,
so a surface stress is used with vertical viscosity.  The Ekman depth
is estimated to be 9 $m$ if $A_v = 0.01 m^2 / s$, so the vertical grid
spacing must resolve this.  The maximum depth is 150 $m$ and our choice
of the vertical grid parameters leads to a surface $\Delta z$ of 4.0
$m$.

\subsubsection{\code{cppdefs.h}}
The C preprocessor variable \code{UPWELLING} is used for the
upwelling configuration of the model. The \code{makefile} will
direct \code{cppdefs.h} to include the file \code{upwelling.h}:
\begin{verbatim}
        #define UV_ADV
        #define UV_COR
        #define UV_LDRAG
        #define UV_VIS2
        #undef  MIX_GEO_UV
        #define MIX_S_UV
        #define TS_U3HADVECTION
        #define TS_C4VADVECTION
        #undef  TS_MPDATA
        #define DJ_GRADPS
        #define TS_DIF2
        #undef  TS_DIF4
        #undef  MIX_GEO_TS
        #define MIX_S_TS

        #define SALINITY
        #define SOLVE3D
        #define SPLINES
        #define AVERAGES
        #define DIAGNOSTICS_TS
        #define DIAGNOSTICS_UV
        #define EW_PERIODIC

        #define ANA_GRID
        #define ANA_INITIAL
        #define ANA_SMFLUX
        #define ANA_STFLUX
        #define ANA_SSFLUX
        #define ANA_BTFLUX
        #define ANA_BSFLUX

        #if defined GLS_MIXING || defined MY25_MIXING
        # define KANTHA_CLAYSON
        # define N2S2_HORAVG
        #else
        # define ANA_VMIX
        #endif

        #if defined BIO_FENNEL  || defined ECOSIM || \
            defined NPZD_POWELL || defined NEMURO || \
            defined BIO_UMAINE
        # define ANA_BIOLOGY
        # define ANA_SPFLUX
        # define ANA_BPFLUX
        # define ANA_SRFLUX
        #endif

        #if defined NEMURO
        # define HOLLING_GRAZING
        # undef  IVLEV_EXPLICIT
        #endif

        #ifdef BIO_FENNEL
        # define CARBON
        # define DENITRIFICATION
        # define BIO_SEDIMENT
        # define DIAGNOSTICS_BIO
        #endif

        #ifdef BIO_UMAINE
        # define OXYGEN
        # undef CARBON
        #endif

        #ifdef PERFECT_RESTART
        # undef  AVERAGES
        # undef  DIAGNOSTICS_BIO
        # undef  DIAGNOSTICS_TS
        # undef  DIAGNOSTICS_UV
        # define OUT_DOUBLE
        #endif
\end{verbatim}
Here we have declared that we want a periodic channel
(\code{EW\_PERIODIC}) but no masking.
There is salinity but we're using a linear equation of state.
The momentum equations have advection, Coriolis force and pressure
gradients. There is both horizontal viscosity and diffusion, but
they are along constant $\sigma$-surfaces and if you check the input
file, you find that the horizontal diffusion is set to zero.

There are ifdefs for various biology cases, none of which
have been defined. Likewise, we are using the default of
\code{ANA\_VMIX} as distributed. We are asking for many other
analytic functions too, including the grid. We are asking
for diagnostic output with the \code{DIAGNOSTICS\_TS} and
\code{DIAGNOSTICS\_UV}.

\subsubsection{Model domain}
The flow does not vary in $x$, so \code{Lm} can be small.
Set the values for \code{Lm}, \code{Mm}, \code{N} and \code{NT} in
the input file:
\begin{verbatim}
          Lm == 41            ! Number of I-direction INTERIOR RHO-points
          Mm == 80            ! Number of J-direction INTERIOR RHO-points
           N == 16            ! Number of vertical levels

         NAT =  2             ! Number of active tracers (usually, 2)
\end{verbatim}

\subsubsection{\code{ana\_grid}}
For this geometry one has a choice of using one of the external
grid-generation programs or of using \code{ana\_grid} to create the grid
analytically. The code in \code{ana\_grid.h} was modified to produce a
bathymetry with a shelf on both walls of the channel when \code{UPWELLING}
is defined. The fluid depth ranges from 27 $m$ on the shelves to 150 $m$
in the center of the channel.  The horizontal grid spacing is uniform
at 1 $km$ and the Coriolis parameter $f$ is set to a constant value
suitable for Sydney, Australia.

\subsubsection{Initial conditions and the equation of state}
We would like the initial conditions to be a motionless fluid with an
exponential stratification. The \code{UPWELLING} section of
\code{ana\_initial.h} is configured accordingly.

The stratification can be provided by either $T$ or $S$, or by both
$T$ and $S$.  For
simplicity we will only have an active temperature field and we will
use the linear equation of state by setting \code{NONLIN\_EOS} to
\code{\#undef}. We want the density to be 26.35 at
the bottom and 24.22 at the top with an e-folding scale of 50 meters.
The initial temperature is set to \code{T0}$ + 8\mbox{e}^{z/50}$ in
\code{ana\_initial}.  The linear equation of state parameters are set
in \code{ocean\_upwelling.in}:
\begin{verbatim}
          R0 == 1027.0d0                   ! kg/m3
          T0 == 14.0d0                     ! Celsius
          S0 == 35.0d0                     ! PSU
       TCOEF == 1.7d-4                     ! 1/Celsius
       SCOEF == 0.0d0                      ! 1/PSU
\end{verbatim}

Since density does not depend on salinity, we have a choice of how to
handle the second tracer. The salinity is set to a uniform value
of \code{S0}, though it could be left out entirely if we undefine
\code{SALINITY} and set \code{NAT} to 1.

\subsubsection{Boundary conditions}
The option \code{EW\_PERIODIC} has been chosen for the eastern and
western edges. None of the open boundary options have been selected
for the Northern and Southern edges; they are both then given the
default wall conditions and no boundary values are required.

\subsubsection{Model forcing}
In this problem we want to resolve the
surface Ekman layer and to use a surface wind stress rather than a body
force.  We want the amplitude of the wind to ramp up with time so we
modify \code{ana\_smflux.h} accordingly.
The wind will build to an amplitude of 0.1 Pascals / $\rho_o$,
or $10^{-4} m^2 s^{-2}$.

We need to edit \code{ana\_vmix.h} to make sure that the
vertical viscosity \code{Akv} is set to the value we want.  This
must be large at the surface ($10^{-2} m^2 s^{-1}$) to create a thick
Ekman layer, but has been chosen to decrease with depth.  We also need
to check that \code{ana\_sbflux}, \code{ana\_stflux}, etc.\ are
set correctly, in this case taking the default of zero rather than
explicitly setting anything for \code{UPWELLING}. However, we do set
\code{ana\_srflux} to be non-zero in case we opt to turn on one of
the biology models.

\subsubsection{ocean.in}
The model has been set up to run for five days with an internal time-step
of 300 $s$ and an external time-step of 10 $s$.
\begin{verbatim}
      NTIMES == 1440
          DT == 300.0d0
     NDTFAST == 30
\end{verbatim}
  We will write history, averages, and diagnostics
records every 1/4 day, restart records once a day.
\begin{verbatim}
       NRREC == 0
   LcycleRST == T
        NRST == 288
     LDEFOUT == T
        NHIS == 72
     NDEFHIS == 0
      NTSAVG == 1
        NAVG == 72
     NDEFAVG == 0
      NTSDIA == 1
        NDIA == 72
     NDEFDIA == 0
\end{verbatim}
  The value of the linear bottom
friction coefficient \code{rdrg} is set to $3.0 \times 10^{-4}$ and the
channel walls are set to be free-slip:
\begin{verbatim}
        RDRG == 3.0d-04                    ! m/s
      GAMMA2 == 1.0d0
\end{verbatim}
The vertical stretching is set to a modest value of
\code{theta\_s}$=3$:
\begin{verbatim}
  Vtransform == 1                          ! transformation equation
 Vstretching == 1                          ! stretching function
     THETA_S == 3.0d0                      ! surface stretching parameter
     THETA_B == 0.0d0                      ! bottom  stretching parameter
      TCLINE == 50.0d0                     ! critical depth (m)
\end{verbatim}

\subsubsection{Output}
\label{Output}
The model writes some information to standard out, after setting
\code{ninfo} to 72:
\begin{verbatim}
 Process Information:

 Thread #  0 (pid=   32022) is active.

 Model Input Parameters:  ROMS/TOMS version 3.2  
                          Friday - October 30, 2009 -  9:11:20 AM
 -----------------------------------------------------------------------------

 Wind-Driven Upwelling/Downwelling over a Periodic Channel

 Operating system : Linux
 CPU/hardware     : x86_64
 Compiler system  : pgi
 Compiler command : /usr/local/pkg/pgi/current/linux86-64/6.1/bin/pgf90
 Compiler flags   :  -O3 -tp k8-64 -Mfree

 SVN Root URL  : https://www.myroms.org/svn/omlab/branches/kate/trunk
 SVN Revision  : 

 Local Root    : /export/staffdata/kate/roms/kate_svn
 Header Dir    : /export/staffdata/kate/roms/kate_svn/ROMS/Include
 Header file   : upwelling.h
 Analytical Dir: /export/staffdata/kate/roms/kate_svn/ROMS/Functionals

 Resolution, Grid 01: 0041x0080x016,  Parallel Threads:  1,  Tiling: 001x001


 Physical Parameters, Grid: 01
 =============================

       1440  ntimes          Number of timesteps for 3-D equations.
    300.000  dt              Timestep size (s) for 3-D equations.
         30  ndtfast         Number of timesteps for 2-D equations between
                               each 3D timestep.
          1  ERstr           Starting ensemble/perturbation run number.
          1  ERend           Ending ensemble/perturbation run number.
          0  nrrec           Number of restart records to read from disk.
          T  LcycleRST       Switch to recycle time-records in restart file.
        288  nRST            Number of timesteps between the writing of data
                               into restart fields.
          1  ninfo           Number of timesteps between print of information
                               to standard output.
          T  ldefout         Switch to create a new output NetCDF file(s).
         72  nHIS            Number of timesteps between the writing fields
                               into history file.
          1  ntsAVG          Starting timestep for the accumulation of output
                               time-averaged data.
         72  nAVG            Number of timesteps between the writing of
                               time-averaged data into averages file.
          1  ntsDIA          Starting timestep for the accumulation of output
                               time-averaged diagnostics data.
         72  nDIA            Number of timesteps between the writing of
                               time-averaged data into diagnostics file.
 0.0000E+00  tnu2(01)        Horizontal, harmonic mixing coefficient (m2/s)
                               for tracer 01: temp
 0.0000E+00  tnu2(02)        Horizontal, harmonic mixing coefficient (m2/s)
                               for tracer 02: salt
 5.0000E+00  visc2           Horizontal, harmonic mixing coefficient (m2/s)
                               for momentum.
 1.0000E-06  Akt_bak(01)     Background vertical mixing coefficient (m2/s)
                               for tracer 01: temp
 1.0000E-06  Akt_bak(02)     Background vertical mixing coefficient (m2/s)
                               for tracer 02: salt
 1.0000E-05  Akv_bak         Background vertical mixing coefficient (m2/s)
                               for momentum.
 3.0000E-04  rdrg            Linear bottom drag coefficient (m/s).
 3.0000E-03  rdrg2           Quadratic bottom drag coefficient.
 2.0000E-02  Zob             Bottom roughness (m).
          1  Vtransform      S-coordinate transformation equation.
          1  Vstretching     S-coordinate stretching function.
 3.0000E+00  theta_s         S-coordinate surface control parameter.
 0.0000E+00  theta_b         S-coordinate bottom  control parameter.
     50.000  Tcline          S-coordinate surface/bottom layer width (m) used
                               in vertical coordinate stretching.
   1025.000  rho0            Mean density (kg/m3) for Boussinesq approximation.
      0.000  dstart          Time-stamp assigned to model initialization (days).
       0.00  time_ref        Reference time for units attribute (yyyymmdd.dd)
 0.0000E+00  Tnudg(01)       Nudging/relaxation time scale (days)
                               for tracer 01: temp
 0.0000E+00  Tnudg(02)       Nudging/relaxation time scale (days)
                               for tracer 02: salt
 0.0000E+00  Znudg           Nudging/relaxation time scale (days)
                               for free-surface.
 0.0000E+00  M2nudg          Nudging/relaxation time scale (days)
                               for 2D momentum.
 0.0000E+00  M3nudg          Nudging/relaxation time scale (days)
                               for 3D momentum.
 0.0000E+00  obcfac          Factor between passive and active
                               open boundary conditions.
     14.000  T0              Background potential temperature (C) constant.
     35.000  S0              Background salinity (PSU) constant.
   1027.000  R0              Background density (kg/m3) used in linear Equation
                               of State.
 1.7000E-04  Tcoef           Thermal expansion coefficient (1/Celsius).
 0.0000E+00  Scoef           Saline contraction coefficient (1/PSU).
      1.000  gamma2          Slipperiness variable: free-slip (1.0) or 
                                                    no-slip (-1.0).
          T  Hout(idFsur)    Write out free-surface.
          T  Hout(idUbar)    Write out 2D U-momentum component.
          T  Hout(idVbar)    Write out 2D V-momentum component.
          T  Hout(idUvel)    Write out 3D U-momentum component.
          T  Hout(idVvel)    Write out 3D V-momentum component.
          T  Hout(idWvel)    Write out W-momentum component.
          T  Hout(idOvel)    Write out omega vertical velocity.
          T  Hout(idTvar)    Write out tracer 01: temp
          T  Hout(idTvar)    Write out tracer 02: salt

 Output/Input Files:

             Output Restart File:  ocean_rst.nc
             Output History File:  ocean_his.nc
            Output Averages File:  ocean_avg.nc
         Output Diagnostics File:  ocean_dia.nc
    IO Variable Information File:  ROMS/External/varinfo.dat

 Tile partition information for Grid 01:  0041x0080x0016  tiling: 001x001

     tile     Istr     Iend     Jstr     Jend     Npts

 Number of tracers:             2
        0        1       41        1       80    52480

 Tile minimum and maximum fractional grid coordinates:
   (interior points only)

     tile     Xmin     Xmax     Ymin     Ymax     grid

        0    -2.50    43.50    -0.50    82.50  RHO-points

        0    -2.50    43.50    -0.50    82.50    U-points

        0    -2.50    43.50    -0.50    82.50    V-points

 Activated C-preprocessing Options:

 UPWELLING           Wind-Driven Upwelling/Downwelling over a Periodic Channel
 ANA_BSFLUX          Analytical kinematic bottom salinity flux.
 ANA_BTFLUX          Analytical kinematic bottom temperature flux.
 ANA_GRID            Analytical grid set-up.
 ANA_INITIAL         Analytical initial conditions.
 ANA_SMFLUX          Analytical kinematic surface momentum flux.
 ANA_SSFLUX          Analytical kinematic surface salinity flux.
 ANA_STFLUX          Analytical kinematic surface temperature flux.
 ANA_VMIX            Analytical vertical mixing coefficients.
 ASSUMED_SHAPE       Using assumed-shape arrays.
 AVERAGES            Writing out time-averaged fields.
 DIAGNOSTICS_TS      Computing and writing tracer diagnostic terms.
 DIAGNOSTICS_UV      Computing and writing momentum diagnostic terms.
 DJ_GRADPS           Parabolic Splines density Jacobian (Shchepetkin, 2002).
 DOUBLE_PRECISION    Double precision arithmetic.
 EW_PERIODIC         East-West periodic boundaries.
 MIX_S_TS            Mixing of tracers along constant S-surfaces.
 MIX_S_UV            Mixing of momentum along constant S-surfaces.
 NONLINEAR           Nonlinear Model.
 !NONLIN_EOS         Linear Equation of State for seawater.
 POWER_LAW           Power-law shape time-averaging barotropic filter.
 PROFILE             Time profiling activated .
 !RST_SINGLE         Double precision fields in restart NetCDF file.
 SALINITY            Using salinity.
 SOLVE3D             Solving 3D Primitive Equations.
 SPLINES             Conservative parabolic spline reconstruction.
 TS_U3HADVECTION     Third-order upstream horizontal advection of tracers.
 TS_C4VADVECTION     Fourth-order centered vertical advection of tracers.
 TS_DIF2             Harmonic mixing of tracers.
 UV_ADV              Advection of momentum.
 UV_COR              Coriolis term.
 UV_U3HADVECTION     Third-order upstream horizontal advection of 3D momentum.
 UV_C4VADVECTION     Fourth-order centered vertical advection of momentum.
 UV_LDRAG            Linear bottom stress.
 UV_VIS2             Harmonic mixing of momentum.
 VAR_RHO_2D          Variable density barotropic mode.

 INITIAL: Configuring and initializing forward nonlinear model ...


 Vertical S-coordinate System: 

 level   S-coord     Cs-curve          at_hmin  over_slope   at_hmax

    16   0.0000000   0.0000000           0.000       0.000     0.000
    15  -0.0625000  -0.0188264          -1.575      -2.750    -3.925
    14  -0.1250000  -0.0383166          -3.150      -5.541    -7.932
    13  -0.1875000  -0.0591578          -4.725      -8.417   -12.108
    12  -0.2500000  -0.0820849          -6.300     -11.422   -16.544
    11  -0.3125000  -0.1079063          -7.875     -14.608   -21.342
    10  -0.3750000  -0.1375324          -9.450     -18.032   -26.614
     9  -0.4375000  -0.1720078         -11.025     -21.758   -32.492
     8  -0.5000000  -0.2125480         -12.600     -25.863   -39.126
     7  -0.5625000  -0.2605826         -14.175     -30.436   -46.696
     6  -0.6250000  -0.3178051         -15.750     -35.581   -55.412
     5  -0.6875000  -0.3862333         -17.325     -41.426   -65.527
     4  -0.7500000  -0.4682798         -18.900     -48.121   -77.341
     3  -0.8125000  -0.5668375         -20.475     -55.846   -91.216
     2  -0.8750000  -0.6853816         -22.050     -64.818  -107.586
     1  -0.9375000  -0.8280918         -23.625     -75.298  -126.971
     0  -1.0000000  -1.0000000         -25.200     -87.600  -150.000

 Time Splitting Weights: ndtfast =  30    nfast =  42

    Primary            Secondary            Accumulated to Current Step

  1-0.0008094437383769 0.0333333333333333-0.0008094437383769 0.0333333333333333
  2-0.0014053566728197 0.0333603147912792-0.0022148004111966 0.0666936481246126
  3-0.0017877524645903 0.0334071600137066-0.0040025528757869 0.1001008081383191
  4-0.0019566842408176 0.0334667517625262-0.0059592371166046 0.1335675599008453
  5-0.0019122901320372 0.0335319745705535-0.0078715272486418 0.1670995344713988
  6-0.0016548570247459 0.0335957175749547-0.0095263842733877 0.2006952520463535
  7-0.0011849025289723 0.0336508794757796-0.0107112868023601 0.2343461315221331
  8-0.0005032751608632 0.0336903762267453-0.0112145619632232 0.2680365077488784
  9 0.0003887272597151 0.0337071520654408-0.0108258347035082 0.3017436598143192
 10 0.0014892209965583 0.0336941944901169-0.0093366137069498 0.3354378543044362
 11 0.0027955815694920 0.0336445537902317-0.0065410321374578 0.3690824080946679
 12 0.0043042707117221 0.0335513677379153-0.0022367614257357 0.4026337758325830
 13 0.0060106451121704 0.0334078920475245 0.0037738836864347 0.4360416678801077
 14 0.0079087469427945 0.0332075372104522 0.0116826306292293 0.4692492050905598
 15 0.0099910761708919 0.0329439123123590 0.0216737068001212 0.5021931174029188
 16 0.0122483446563884 0.0326108764399960 0.0339220514565096 0.5348039938429148
 17 0.0146692120341107 0.0322025982847830 0.0485912634906203 0.5670065921276978
 18 0.0172400033810439 0.0317136245503127 0.0658312668716642 0.5987202166780104
 19 0.0199444086685725 0.0311389577709445 0.0857756755402367 0.6298591744489550
 20 0.0227631639997064 0.0304741441486588 0.1085388395399431 0.6603333185976138
 21 0.0256737146312911 0.0297153720153352 0.1342125541712341 0.6900486906129490
 22 0.0286498597812016 0.0288595815276255 0.1628624139524358 0.7189082721405745
 23 0.0316613792205220 0.0279045862015855 0.1945237931729577 0.7468128583421599
 24 0.0346736416507075 0.0268492068942347 0.2291974348236652 0.7736620652363947
 25 0.0376471948657328 0.0256934188392112 0.2668446296893980 0.7993554840756058
 26 0.0405373376992232 0.0244385123436867 0.3073819673886213 0.8237939964192925
 27 0.0432936737565710 0.0230872677537126 0.3506756411451923 0.8468812641730052
 28 0.0458596469320356 0.0216441452951603 0.3965352880772279 0.8685254094681655
 29 0.0481720587108285 0.0201154903974257 0.4447073467880564 0.8886408998655913
 30 0.0501605672561820 0.0185097551070648 0.4948679140442383 0.9071506549726561
 31 0.0517471682814031 0.0168377361985254 0.5466150823256414 0.9239883911711814
 32 0.0528456577069106 0.0151128305891453 0.5994607400325521 0.9391012217603267
 33 0.0533610761022577 0.0133513086655816 0.6528218161348097 0.9524525304259083
 34 0.0531891349131380 0.0115726061288397 0.7060109510479476 0.9640251365547480
 35 0.0522156244733761 0.0097996349650684 0.7582265755213236 0.9738247715198163
 36 0.0503158038019030 0.0080591141492892 0.8085423793232266 0.9818838856691055
 37 0.0473537721847154 0.0063819206892258 0.8558961515079421 0.9882658063583314
 38 0.0431818225418188 0.0048034616164019 0.8990779740497608 0.9930692679747333
 39 0.0376397765791564 0.0033640675316746 0.9367177506289172 0.9964333355064079
 40 0.0305543017255206 0.0021094083123694 0.9672720523544379 0.9985427438187774
 41 0.0217382098544504 0.0010909315881854 0.9890102622088882 0.9996336754069628
 42 0.0109897377911118 0.0003663245930371 1.0000000000000000 0.9999999999999998

 ndtfast, nfast =   30  42   nfast/ndtfast = 1.40000

 Centers of gravity and integrals (values must be 1, 1, approx 1/2, 1, 1):

    1.000000000000 1.047601458608 0.523800729304 1.000000000000 1.000000000000

 Power filter parameters, Fgamma, gamma =  0.28400   0.18933

 Minimum X-grid spacing, DXmin =  1.00000000E+00 km
 Maximum X-grid spacing, DXmax =  1.00000000E+00 km
 Minimum Y-grid spacing, DYmin =  1.00000000E+00 km
 Maximum Y-grid spacing, DYmax =  1.00000000E+00 km
 Minimum Z-grid spacing, DZmin =  1.57503054E+00 m
 Maximum Z-grid spacing, DZmax =  2.30290891E+01 m

 Minimum barotropic Courant Number =  2.22358627E-01
 Maximum barotropic Courant Number =  5.42494240E-01
 Maximum Coriolis   Courant Number =  2.47800000E-02


 Maximum grid stiffness ratios:  rx0 =   6.931666E-02 (Beckmann and Haidvogel)
                                 rx1 =   1.188435E+00 (Haney)


 Initial basin volumes: TotVolume =  3.8843755884E+11 m3
                        MinVolume =  1.6168290365E+06 m3
                        MaxVolume =  2.3029089059E+07 m3
                          Max/Min =  1.4243366824E+01

NL ROMS/TOMS: started time-stepping: (Grid: 01 TimeSteps: 00000001 - 00001440)

   STEP   Day HH:MM:SS  KINETIC_ENRG   POTEN_ENRG    TOTAL_ENRG   NET_VOLUME
      0     0 00:00:00  0.000000E+00  6.579497E+02  6.579497E+02 3.884376E+11
      DEF_HIS   - creating history file: ocean_his.nc
      WRT_HIS   - wrote history  fields (Index=1,1) into time record = 0000001
      DEF_AVG   - creating average file: ocean_avg.nc
      DEF_DIAGS - creating diagnostics file: ocean_dia.nc
     72     0 06:00:00  8.366194E-06  6.579497E+02  6.579497E+02 3.884376E+11
      WRT_HIS   - wrote history  fields (Index=1,1) into time record = 0000002
      WRT_AVG   - wrote averaged fields into time record = 0000001
      WRT_DIAGS - wrote diagnostics fields into time record = 0000001
    144     0 12:00:00  7.416156E-05  6.579497E+02  6.579498E+02 3.884376E+11
      WRT_HIS   - wrote history  fields (Index=1,1) into time record = 0000003
      WRT_AVG   - wrote averaged fields into time record = 0000002
      WRT_DIAGS - wrote diagnostics fields into time record = 0000002
    216     0 18:00:00  2.317054E-04  6.579497E+02  6.579499E+02 3.884376E+11
      WRT_HIS   - wrote history  fields (Index=1,1) into time record = 0000004
      WRT_AVG   - wrote averaged fields into time record = 0000003
      WRT_DIAGS - wrote diagnostics fields into time record = 0000003
    288     1 00:00:00  5.382882E-04  6.579497E+02  6.579503E+02 3.884376E+11
      WRT_HIS   - wrote history  fields (Index=1,1) into time record = 0000005
      WRT_AVG   - wrote averaged fields into time record = 0000004
      WRT_DIAGS - wrote diagnostics fields into time record = 0000004
      WRT_RST   - wrote re-start fields (Index=1,1) into time record = 0000001
            :
   1440     5 00:00:00  2.476731E-02  6.579533E+02  6.579781E+02
3.884376E+11
      WRT_HIS   - wrote history  fields (Index=1,1) into time record
= 0000021
      WRT_AVG   - wrote averaged fields into time record =
0000020
      WRT_DIAGS - wrote diagnostics fields into time record =
0000020
      WRT_RST   - wrote re-start fields (Index=1,1) into time record
= 0000001

 Elapsed CPU time (seconds):

 Thread #  0 CPU:     557.021
 Total:               557.021

 Nonlinear model elapsed time profile:

  Initialization ...................................         0.015  ( 0.0027 %)
  Reading of input data ............................         0.002  ( 0.0004 %)
  Processing of input data .........................         0.127  ( 0.0229 %)
  Processing of output time averaged data ..........        55.303  ( 9.9284 %)
  Computation of vertical boundary conditions ......         0.419  ( 0.0752 %)
  Computation of global information integrals ......         2.316  ( 0.4159 %)
  Writing of output data ...........................         1.923  ( 0.3453 %)
  Model 2D kernel ..................................       365.560  (65.6278 %)
  2D/3D coupling, vertical metrics .................         1.950  ( 0.3500 %)
  Omega vertical velocity ..........................         3.135  ( 0.5628 %)
  Equation of state for seawater ...................         1.645  ( 0.2954 %)
  3D equations right-side terms ....................        14.268  ( 2.5615 %)
  3D equations predictor step ......................        31.518  ( 5.6583 %)
  Pressure gradient ................................        10.157  ( 1.8235 %)
  Harmonic mixing of tracers, S-surfaces ...........         4.130  ( 0.7414 %)
  Harmonic stress tensor, S-surfaces ...............         8.211  ( 1.4741 %)
  Corrector time-step for 3D momentum ..............        27.976  ( 5.0225 %)
  Corrector time-step for tracers ..................        19.558  ( 3.5112 %)
                                              Total:       548.216   98.4193

 All percentages are with respect to total time =          557.021

 ROMS/TOMS - Output NetCDF summary for Grid 01:
             number of time records written in HISTORY file = 00000021
             number of time records written in RESTART file = 00000002
             number of time records written in AVERAGE file = 00000020

 Analytical header files used:

     ROMS/Functionals/ana_btflux.h
     ROMS/Functionals/ana_grid.h
     ROMS/Functionals/ana_initial.h
     ROMS/Functionals/ana_smflux.h
     ROMS/Functionals/ana_stflux.h
     ROMS/Functionals/ana_vmix.h

 ROMS/TOMS: DONE... Friday - October 30, 2009 -  9:20:38 AM
\end{verbatim}
Note that it ends by printing out a profile of where the time was
used---the ratios will vary depending on the application.

NetCDF history and restart files are also created, containing
the model fields at the requested times. We have asked it to save 
restart records every day. In this case, the restart
file has been told to ``cycle'', or to write over the second last
record. The restart file at the end of the run contains the fields at
day 4 and day 5. The history file contains records for 0, 1/4, 1/2,
3/4, and 1 day, etc., while the averages and diagnostics files are
at 1/8, 3/8, 5/8, and 7/8 day, etc..
Plots can be made from any one of these files, using the plotting
software described in \S\ref{Plothist}.  Selected frames from
such plots are shown in Fig.\ \ref{fsm1} to \ref{fsm2}.

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(-3.65,0)
\includegraphics{pics/up1}
\end{picture}
\caption{The upwelling/downwelling bathymetry.}
\label{fsm1}
\end{figure}

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(-3.75,0)
\includegraphics{pics/up2}
  \end{picture}
\caption{Surface velocities after one day, showing the flow to the
left of the wind (southern hemisphere).}
\end{figure}

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(0,0)
\includegraphics[width=6.5in]{pics/up3}
  \end{picture}
\caption{Constant $\xi$ slices of the $u, v, T$ and $w$ fields
at day 1.}
\end{figure}

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(0,0)
\includegraphics[width=6.5in]{pics/up4}
  \end{picture}
\caption{Constant $\xi$ slices of the $u, v, T$, and $w$ fields
at day 5.}
\label{fsm2}
\end{figure}

\subsection{Northeast Pacific example}
\label{NEP}
The upwelling/downwelling examples is one in which all the start-up
fields are defined analytically.  The other extreme is one in which
everything is read from files, as in our Northeast Pacific simulations.
Figure \ref{fbath_nep5} shows the bathymetry and the extent of this
domain, which is rectangular in a conic map projection.

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(0,0)
\includegraphics{pics/bath_NEP5}
  \end{picture}
\caption{Bathymetry of the Northeast Pacific domain (NEP5).}
\label{fbath_nep5}
\end{figure}

\subsubsection{\code{nep5.h}}
The C preprocessor variable \code{NEP5} has been chosen to
label our Northeast Pacific domain, using the
fifth generation grid file. The header include file then becomes
\code{nep5.h}:
\begin{verbatim}
/*
**  Options for Northeast Pacific (NEP5) simulation
*/
 
#undef NETCDF4
#undef PARALLEL_IO
#undef OFFLINE_FLOATS

/* general */

#define CURVGRID
#define MASKING
#define NONLIN_EOS
#define SOLVE3D
#define SALINITY
#ifdef SOLVE3D
# undef SPLINES
#endif
#define FLOATS
#define STATIONS
#undef WET_DRY

#undef T_PASSIVE
#ifdef T_PASSIVE
# define ANA_PASSIVE
#endif
 
/* ice */

#ifdef SOLVE3D
# define  ICE_MODEL
# ifdef ICE_MODEL
#  define  ICE_THERMO
#  define  ICE_MK
#  undef   ICE_ALB_EC92
#  undef   ICE_SMOOTH
#  define  ICE_MOMENTUM
#  define  ICE_MOM_BULK
#  define  ICE_EVP
#  define  ICE_ADVECT
#  define  ICE_SMOLAR
#  define  ICE_UPWIND
#  define  ICE_BULK_FLUXES
#  define  ANA_AIOBC
#  define  ANA_HIOBC
#  define  ANA_HSNOBC
# endif
#endif

/* output stuff */
 
#define NO_WRITE_GRID
#undef OUT_DOUBLE
#define RST_SINGLE
#define AVERAGES
#undef AVERAGES2
#ifdef SOLVE3D
# undef AVERAGES_DETIDE
# define AVERAGES_AKT
# define AVERAGES_AKS
# define AVERAGES_AKV
# define AVERAGES_FLUXES
# undef AVERAGES_QUADRATIC
# undef DIAGNOSTICS_TS
#endif
#undef DIAGNOSTICS_UV
 
/* advection, dissipation, pressure grad, etc. */
 
#ifdef SOLVE3D
# define DJ_GRADPS
#endif
 
#define UV_ADV
#define UV_COR
#define UV_SADVECTION
 
#ifdef SOLVE3D
# define TS_U3HADVECTION
# define TS_C4VADVECTION
# undef TS_MPDATA
#endif
 
#define UV_VIS2
#define UV_SMAGORINSKY
#define VISC_3DCOEF
#define MIX_S_UV
#define VISC_GRID
#define SPONGE

#ifdef SOLVE3D
# define TS_DIF2
# define MIX_GEO_TS
# define DIFF_GRID
#endif
 
 
/* vertical mixing */
 
#ifdef SOLVE3D
# define SOLAR_SOURCE
 
# define LMD_MIXING
# ifdef LMD_MIXING
#  define LMD_RIMIX
#  define LMD_CONVEC
#  define LMD_SKPP
#  undef LMD_BKPP
#  define LMD_NONLOCAL
#  define LMD_SHAPIRO
#  undef LMD_DDMIX
# endif
 
# undef GLS_MIXING
# undef MY25_MIXING

# if defined GLS_MIXING || defined MY25_MIXING
#  define KANTHA_CLAYSON
#  define N2S2_HORAVG
# endif
#endif
 
/* surface forcing */
 
#ifdef SOLVE3D
# define CORE_FORCING
# define BULK_FLUXES
# define CCSM_FLUXES
# if defined BULK_FLUXES || defined CCSM_FLUXES
#  define LONGWAVE_OUT
#  define DIURNAL_SRFLUX
#  define EMINUSP
#  undef ANA_SRFLUX
#  undef ALBEDO
#  undef LONGWAVE
# endif
#endif
 
/* surface and side corrections */
 
#ifdef SOLVE3D
# define SRELAXATION
# undef QCORRECTION
#endif
 
/* point sources (rivers, line sources) */
 
/* Using Runoff instead now */
#ifdef SOLVE3D
#define RUNOFF
# define UV_PSOURCE
# define ANA_PSOURCE
# undef TS_PSOURCE
#endif
 
/* tides */
 
#define LTIDES
#ifdef LTIDES
# define FILTERED
# define SSH_TIDES
# define UV_TIDES
# define ADD_FSOBC
# define ADD_M2OBC
# undef RAMP_TIDES
# define TIDES_ASTRO
# define POT_TIDES

# define UV_LDRAG
# define RDRG_GRID
# define DRAG_LIMITER
# undef UV_QDRAG
#else
# define UV_QDRAG
#endif
 
/* Boundary conditions...careful with grid orientation */
 
#define EASTERN_WALL
#define NORTHERN_WALL
#undef WESTERN_WALL
#undef SOUTHERN_WALL
 
#define RADIATION_2D
 
#ifndef NORTHERN_WALL
# define NORTH_FSCHAPMAN
# define NORTH_M2FLATHER
# ifdef SOLVE3D
#  define NORTH_M3RADIATION
#  define NORTH_M3NUDGING
#  define NORTH_TRADIATION
#  define NORTH_TNUDGING
#  define NORTH_MIGRADIENT
# endif
#endif
 
#ifndef WESTERN_WALL
# define WEST_FSCHAPMAN
# define WEST_M2FLATHER
# ifdef SOLVE3D
#  define WEST_M3RADIATION
#  define WEST_M3NUDGING
#  define WEST_TRADIATION
#  define WEST_TNUDGING
#  define WEST_MIGRADIENT
# endif
#endif
 
#ifndef SOUTHERN_WALL
# define SOUTH_FSCHAPMAN
# define SOUTH_M2FLATHER
# ifdef SOLVE3D
#  define SOUTH_M3RADIATION
#  define SOUTH_M3NUDGING
#  define SOUTH_TRADIATION
#  define SOUTH_TNUDGING
#  define SOUTH_MIGRADIENT
# endif
#endif
 
#ifndef EASTERN_WALL
# define EAST_FSCHAPMAN
# define EAST_M2FLATHER
# ifdef SOLVE3D
#  define EAST_M3RADIATION
#  define EAST_M3NUDGING
#  define EAST_TRADIATION
#  define EAST_TNUDGING
#  define EAST_MIGRADIENT
# endif
#endif
 
/* roms quirks */
 
#ifdef SOLVE3D
# define ANA_BSFLUX
# define ANA_BTFLUX
#else
# define ANA_SMFLUX
#endif

/*
**  Biological model options.
*/
#define NEMURO
#define LIMIT_BIO_AKT
#undef BIO_GOANPZ        /* Sarah Hinckley's 11 box model */
#undef BEST_NPZ         /* Georgina Gibsons BEST NPZ model  */

#if defined BEST_NPZ || defined BIO_GOANPZ || defined PASSIVE_TRACERS
# undef  BIOFLUX           /* sum Nitrogen fluxes between boxes */
# define ANA_BIOLOGY       /* analytical biology initial conditions */
# define ANA_BPFLUX        /* analytical bottom passive tracers fluxes */
# define ANA_SPFLUX        /* analytical surface passive tracers fluxes */
# define DIAPAUSE          /* Enable Neocalanus seasonal vertical migration */
# undef FLOAT_VWALK
# define IRON_LIMIT        /* Add iron as passive 11th tracer */
# undef TCLM_NUDGING      /* Nudging of tracer climatology for iron */
#endif

#if defined NEMURO
# undef ANA_BIOLOGY       /* analytical biology initial conditions */
# define ANA_BPFLUX        /* analytical bottom passive tracers fluxes */
# define ANA_SPFLUX        /* analytical surface passive tracers fluxes */
# define IRON_LIMIT        /* Add iron as passive 11th tracer */
# define IRON_RELAX
# undef  IRON_RSIN
# define BIO_SEDIMENT
# define HOLLING_GRAZING
# undef  IVLEV_EXPLICIT
# undef  ANA_BIOSWRAD
# undef  DIAGNOSTICS_BIO
# undef  BIO_SEDIMENT
#endif
\end{verbatim}
Here, we have declared that we want two open sides and two closed
walls. For each open side, we're using a Chapman/Flather combination
on the 2D flow and a radiation/nudging combination on the 3D flow.
We've got masking, salinity, and the non-linear equation of state.
We want Laplacian viscosity on $\sigma$-surfaces, diffusion along constant
$z$-surfaces and the full non-linear, curvilinear momentum equations.
Sea ice is turned on, as is the \code{NEMURO} ecosystem (for some
runs at least).

Notice that comments are allowed in this file as long as they are in
the C/C++ syntax. Also, conditionals are fine---some parts are only
wanted when \code{SOLVE3D} is on. There is evidence of options
having been tried and rejected, such as the quadratic bottom drag
in the presence of tides. The ``Eastern'' side is actually open to
the North, up in the Arctic, but it is set to be a closed boundary.
Instead, there is an imposed flow through Bering Strait by using
\code{UV\_PSOURCE} and \code{ANA\_PSOURCE}.

\subsubsection{NEP5 code chunks}
As mentioned above, we are specifying point sources in
\code{ana\_psource.h}. The \code{NEP5} section of the copy in
\code{Apps/NEP} is:
\begin{verbatim}
#if defined NEP5
        Nsrc=149
        DO is=1,Nsrc
          Dsrc(is)=0.0_r8
          Isrc(is)=225
          Jsrc(is)=472+is
          Lsrc(is,itemp)=.FALSE.
          Lsrc(is,isalt)=.FALSE.
        END DO
#elif defined BERING_10K
            :

#if defined UV_PSOURCE || defined Q_PSOURCE
# ifdef SOLVE3D
!
!  If appropriate, set-up nondimensional shape function to
distribute
!  mass point sources/sinks vertically.  It must add to unity!!.
!
#  if defined NEP5
        DO k=1,N(ng)
          DO is=1,Nsrc
            Qshape(is,k)=1.0_r8/REAL(N(ng),r8)
          END DO
        END DO
#  endif
# endif
# if defined NEP5
      cff = 800000._r8/Nsrc
      DO is=1,Nsrc
        Qbar(is)=cff
      END DO
# else
      ana_psource.h: No values provided for Qbar.
# endif
\end{verbatim}
The total transport is set to 0.8 Sv and is divided among the
\code{Nsrc} sources.

Doing a search for \code{NEP5} shows up a few other instances. One
is in \code{output.F}, forcing more digits in the averages file names
for handling one file per record, one record per day for fifty
years:
\begin{verbatim}
#ifdef NEP5
  20          FORMAT (a,'_',i5.5,'.nc')
#else
  20          FORMAT (a,'_',i4.4,'.nc')
#endif
\end{verbatim}
Also in \code{output.F} is code to ask for a new stations file for
each run rather than appending to the old one:
\begin{verbatim}
#ifdef NEP5
          CALL def_station (ng, .true.)
#else
          CALL def_station (ng, ldefout(ng))
#endif
\end{verbatim}
A better fix (someday) would be to allow the station files to be
numbered just like the averages files. Why not set \code{ldefout} to
be true? It is shared by many outputs, including the floats, and you
can only restart floats with \code{ldefout} set to false.

One feature which got turned on after the two decade ``run 35'' is
\code{SRELAXATION}, in which I'm nudging the sea surface salinity to
a value from a forcing file. If you check the nudging code, you will
find that the timescale for nudging is the same as that used for the
open boundary conditions. That isn't quite what I want, so there's
this change to \code{set\_vbc.F}:
\begin{verbatim}
    #   elif defined SRELAXATION
              stflx(i,j,isalt)=-Tnudg(isalt,ng)*Hz(i,j,N(ng))*      &
    #ifdef NEP5   
    !  60 days from Tnudg of 360 days
         &                     6.0_r8*                              &
    #endif
         &                     (t(i,j,N(ng),nrhs,isalt)-sss(i,j))
\end{verbatim}
There is also a kludge in \code{step\_floats.F} for a yet-untested
float reuse strategy. Having a handy tag like \code{NEP5} allows me
to search for these little hacks later. The file
\code{Apps/NEP/ana\_hmixcoef.h} tried to sneak by without any
\code{NEP5}, but the location means that it will be used to set up
the sponge layers for this domain:
\begin{verbatim}
    !
    ! Northeast Pacific sponge areas
    !
          Iwrk = 10
    #  if defined UV_VIS2
          DO i=IstrR,IendR
            DO j=JstrR,MIN(Iwrk,JendR)
              cff = 250.*0.5_r8*(1.0_r8+COS(pi*REAL(j,r8)/REAL(Iwrk,r8)))
              visc2_r(i,j) = max(cff, visc2_r(i,j))
              visc2_p(i,j) = max(cff, visc2_p(i,j))
            END DO
          END DO
          DO i=IstrR,MIN(Iwrk,IendR)
            DO j=MAX(JstrR,i),JendR
              cff = 250.*0.5_r8*(1.0_r8+COS(pi*REAL(i,r8)/REAL(Iwrk,r8)))
              visc2_r(i,j) = max(cff, visc2_r(i,j))
              visc2_p(i,j) = max(cff, visc2_p(i,j))
            END DO
          END DO
            :
    #   if defined TS_DIF2
          DO itrc=1,NT(ng)
            DO j=JstrR,MIN(Iwrk,JendR)
              cff = 100. * (1.0_r8+COS(pi*REAL(j,r8)/REAL(Iwrk,r8)))
              DO i=IstrR,IendR
                diff2(i,j,itrc)=max(cff, diff2(i,j,itrc))
              END DO
            END DO
            DO i=IstrR,MIN(Iwrk,IendR)
              DO j=MAX(JstrR,i),JendR
                cff = 100. * (1.0_r8+COS(pi*REAL(i,r8)/REAL(Iwrk,r8)))
                diff2(i,j,itrc) = max(cff, diff2(i,j,itrc))
              END DO
            END DO
\end{verbatim}

\subsubsection{Model domain}
A number of horizontal grid points was chosen to resolve the
domain at roughly 10 km. Values for \code{Lm}, \code{Mm}, and
\code{N} are:
\begin{verbatim}
          Lm == 224           ! Number of I-direction INTERIOR RHO-points
          Mm == 640           ! Number of J-direction INTERIOR RHO-points
           N == 60            ! Number of vertical levels
\end{verbatim}
The vertical structure is the same as we've been using for a good
long time now, though the minimum depth keeps creeping shallower:
\begin{verbatim}
  Vtransform == 1                          ! transformation equation
 Vstretching == 1                          ! stretching function

     THETA_S == 5.0d0                      ! surface stretching parameter
     THETA_B == 0.4d0                      ! bottom  stretching parameter
      TCLINE == 10.0d0                     ! critical depth (m)
\end{verbatim}

\subsubsection{Initial and boundary conditions}
The best fields we know of at the moment are known as SODA, a
reanalysis from 1958 through 2005 by Carton et al.\
(\cite{Carton_2005}). There are \code{Matlab} scripts to create
initial and boundary conditions from the SODA files.

\subsubsection{Forcing}
We are using the CORE forcing files (\cite{Large_08}) and computing the
momentum, heat and salt fluxes from the atmospheric conditions and the
model's surface temperature. There are two options, one provided by
\code{bulk\_flux.F} and the other provided by \code{ccsm\_flux.F}. We
are opting to use the second. With minimal fussing, the CORE files
can be used as is, on their native grid, then interpolated by ROMS
internally to the domain at hand.

\subsubsection{ocean.in}
We use an internal time-step of 200 $s$ and an external time-step of 10
$s$. The horizontal viscosity and diffusion is:
\begin{verbatim}
        TNU2 == 5.0d0  5.0d0                    ! m2/s
       VISC2 == 25.0d0                          ! m2/s
\end{verbatim}
plus the sponge layers as shown above along the SE and SW boundaries.

\subsubsection{Output}
The model writes voluminous information to standard out, as shown
for the \code{UPWELLING} case.
It also writes out NetCDF files for restart, history, daily
averages, stations and floats.  Plots can be made from any of
these files; some examples are shown in Fig.\
\ref{fnep1}--\ref{fnep2} .

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(-1.1,0)
\includegraphics{pics/zeta_NEP5}
  \end{picture}
\caption{Surface elevation after 200 days showing tides. This is
from a snapshot in a history file---the averages files have been
detided.}
\label{fnep1}
\end{figure}

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(-1.1,0)
\includegraphics{pics/aice_NEP5}
  \end{picture}
\caption{Ice concentration averaged over the month of April, 1959.}
\end{figure}

\begin{figure}
\setlength{\unitlength}{10mm}
\begin{picture}(0,16)(-0.2,0)
\includegraphics{pics/tslice_NEP5}
  \end{picture}
\caption{Vertical slice if temperature, averaged over the month of
April, 1959. The slice is across the Bering Sea shelf, showing the
transition from vertically mixed at the coast, a two layer system at
mid-shelf, then a thermocline over the shelf-break.}
\label{fnep2}
\end{figure}

